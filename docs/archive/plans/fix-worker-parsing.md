# Plan: Fix Worker Message Parsing Issue

## Problem Statement

The worker is receiving messages from NATS JetStream but failing to parse them with the error:
```
ERROR worker: Failed to process message: InvalidFormat("Could not parse as any known entity type")
```

**Current Status:**
- ✅ Ingestion API: Running and accepting messages at `/O` endpoint
- ✅ NATS JetStream: Messages are being published successfully
- ✅ Worker: Running and consuming messages from NATS
- ❌ Worker: Cannot parse MessageEnvelope format

**Test Data:**
- Test Order with 2 LineItems sent successfully via: `curl -X POST http://localhost:8080/O -d @/tmp/test_order.json`
- Database shows 0 records in `order_line_items` and `orders` tables
- Worker logs show parsing failures

## Root Cause Analysis

### 1. Message Flow

```
Client → Ingestion API → NATS JetStream → Worker → Database
         (wraps in         (publishes)      (fails to
          MessageEnvelope)                   parse)
```

### 2. MessageEnvelope Structure

**Generated by Ingestion API** (`/tmp/nomnom-ingestion-api-fixed/src/message_envelope.rs`):
```rust
pub struct MessageEnvelope {
    pub message_id: Uuid,
    pub body: String,              // Raw JSON string
    pub entity_type: Option<String>, // e.g., "Order", "OrderLineItem"
    pub received_at: DateTime<Utc>,
    pub retry_count: u32,
    pub source: Option<String>,
}
```

**Expected by Worker:**
- Worker must unwrap the envelope
- Parse the `body` field as JSON
- Match `entity_type` to known entities (Order, OrderLineItem, Customer, Product)

### 3. Potential Issues

1. **Entity Type Mismatch:** The `entity_type` field may not match entity names
   - Ingestion API might be using prefix "O" instead of "Order"
   - Worker expects exact entity names: "Order", "OrderLineItem"

2. **Missing Entity Definitions:** Worker may not have entity configurations
   - Check if `/app/entities.ron` exists in worker container
   - Verify entity definitions match ingestion API

3. **JSON Parsing:** Worker might fail to parse the `body` string
   - Raw JSON in `body` should be valid
   - Worker needs JSON→Entity deserialization logic

## Investigation Steps

### Step 1: Examine Worker Code Generation

**Files to Check:**
- `/Users/bogdanstate/nomnom/src/codegen/worker/mod.rs` - Worker code generator
- `/Users/bogdanstate/nomnom/src/codegen/worker/main_rs.rs` - Worker main entry point
- Look for where the worker parses MessageEnvelope

**Questions:**
1. Does the worker have code to unwrap MessageEnvelope?
2. How does it extract `entity_type` and `body`?
3. Is there entity matching logic?

### Step 2: Check Worker Binary

**Commands:**
```bash
# Check if entities.ron exists in worker
kubectl exec -n nomnom-dev nomnom-worker-57fffcb977-hdmcn -- ls -la /app/

# View entities.ron content
kubectl exec -n nomnom-dev nomnom-worker-57fffcb977-hdmcn -- cat /app/entities.ron

# Check worker environment
kubectl exec -n nomnom-dev nomnom-worker-57fffcb977-hdmcn -- env | grep -E "(NATS|DATABASE)"
```

### Step 3: Inspect NATS Messages

**Commands:**
```bash
# Port forward to NATS
kubectl port-forward -n nomnom-dev nomnom-nats-0 4222:4222

# Use nats CLI to peek at messages (if available)
nats stream view MESSAGES --last

# Or check NATS monitoring API
curl http://localhost:8222/jsz?streams=1
```

### Step 4: Check Message Format

**Compare what's sent vs what's expected:**

**Sent by Ingestion API:**
```json
{
  "message_id": "uuid-here",
  "body": "{\"order_key\":\"ORD-001\",\"customer_key\":\"CUST-123\",...}",
  "entity_type": "Order",  // or maybe "O" ?
  "received_at": "2025-11-13T17:51:27Z",
  "retry_count": 0,
  "source": null
}
```

**Expected by Worker:**
- Entity type should be "Order" (not "O")
- Body should be parseable JSON
- Worker needs to match "Order" to its entity definitions

## Solution Options

### Option 1: Fix Entity Type in Ingestion API

**If the ingestion API is using prefix "O" instead of "Order":**

**File:** `/Users/bogdanstate/nomnom/src/codegen/ingestion_server/handlers_rs.rs`

**Find:** Where `entity_type` is set in MessageEnvelope
**Change:** Use full entity name instead of prefix
```rust
// Before (probably):
envelope.entity_type = Some(prefix.to_string()); // "O"

// After:
envelope.entity_type = Some(entity_name.to_string()); // "Order"
```

### Option 2: Fix Entity Matching in Worker

**If worker needs to map prefixes to entity names:**

**File:** `/Users/bogdanstate/nomnom/src/codegen/worker/main_rs.rs`

**Add:** Prefix-to-entity mapping
```rust
fn map_prefix_to_entity(prefix: &str) -> Option<String> {
    match prefix {
        "O" => Some("Order".to_string()),
        "L" => Some("OrderLineItem".to_string()),
        "C" => Some("Customer".to_string()),
        "P" => Some("Product".to_string()),
        _ => None,
    }
}
```

### Option 3: Fix MessageEnvelope Parsing

**If worker expects a different envelope format:**

**File:** Check worker's message parsing logic

**Ensure:**
1. Worker has `serde_json::from_str` for envelope
2. Worker can extract and parse `body` field
3. Entity type matching is case-sensitive

## Implementation Plan

### Phase 1: Diagnosis (30 minutes)

1. **Read worker code generator**
   ```bash
   # In /Users/bogdanstate/nomnom/
   cat src/codegen/worker/main_rs.rs | head -200
   ```

2. **Check generated worker**
   ```bash
   # Look at what entities the worker knows about
   kubectl exec -n nomnom-dev nomnom-worker-xxx -- cat /app/entities.ron
   ```

3. **Examine NATS messages**
   ```bash
   # Check what's actually in NATS
   kubectl port-forward -n nomnom-dev nomnom-nats-0 8222:8222
   curl http://localhost:8222/jsz?streams=1&consumers=1
   ```

### Phase 2: Fix Code Generator (1 hour)

Based on diagnosis, fix one of:
1. **Ingestion API handler** - Use full entity name not prefix
2. **Worker parser** - Add prefix-to-entity mapping
3. **Both** - Standardize on entity names throughout

**Files to Edit:**
- `src/codegen/ingestion_server/handlers_rs.rs` (if fixing ingestion API)
- `src/codegen/worker/main_rs.rs` (if fixing worker)
- `src/codegen/worker/message_handler_rs.rs` (if it exists)

### Phase 3: Regenerate and Rebuild (30 minutes)

1. **Regenerate worker**
   ```bash
   cargo build --release
   ./target/release/nomnom generate-worker \
     --entities config/examples/tpch/entities \
     --output /tmp/nomnom-worker-fixed \
     --database postgresql
   ```

2. **Rebuild Docker image**
   ```bash
   cd /tmp/nomnom-worker-fixed
   docker build -t localhost:5001/nomnom-worker:fixed .
   docker push localhost:5001/nomnom-worker:fixed
   ```

3. **Update Helm deployment**
   ```bash
   helm upgrade nomnom nomnom-helm -n nomnom-dev \
     --reuse-values \
     --set worker.image.tag=fixed
   ```

### Phase 4: Test (30 minutes)

1. **Clear NATS streams** (optional, to start fresh)
   ```bash
   kubectl exec -n nomnom-dev nomnom-nats-0 -- \
     nats stream purge MESSAGES --force
   ```

2. **Send test message**
   ```bash
   kubectl port-forward -n nomnom-dev svc/nomnom-ingestion-api 8080:8080
   curl -X POST http://localhost:8080/O \
     -H "Content-Type: application/json" \
     -d @/tmp/test_order.json
   ```

3. **Verify worker processing**
   ```bash
   # Check logs for success
   kubectl logs -n nomnom-dev -l app.kubernetes.io/component=worker --tail=50

   # Check database
   kubectl exec -n nomnom-dev nomnom-postgres-0 -- \
     psql -U postgres -d nomnom -c "SELECT * FROM orders;"

   kubectl exec -n nomnom-dev nomnom-postgres-0 -- \
     psql -U postgres -d nomnom -c "SELECT * FROM order_line_items;"
   ```

4. **Verify dashboard updates**
   ```bash
   # Port forward to dashboard
   kubectl port-forward -n nomnom-dev svc/nomnom-dashboard-frontend 30570:5173

   # Open http://localhost:30570 in browser
   # Should see Order and OrderLineItems appear in real-time
   ```

## Success Criteria

- ✅ Worker logs show: "Successfully processed message for entity 'Order'"
- ✅ Database contains 1 row in `orders` table
- ✅ Database contains 2 rows in `order_line_items` table
- ✅ Dashboard shows Order and OrderLineItems in real-time
- ✅ No parsing errors in worker logs

## Rollback Plan

If fixes don't work:
1. Revert to previous worker image: `kubectl rollout undo deployment/nomnom-worker -n nomnom-dev`
2. Restore previous code generator files from git
3. Document findings for further investigation

## Next Steps After Fix

1. **End-to-End Testing:** Send 10 test orders, verify all process correctly
2. **Performance Testing:** Measure throughput (messages/second)
3. **Error Handling:** Test malformed JSON, missing fields
4. **Dashboard Polish:** Fix WebSocket connection (already done in code generator)
5. **Documentation:** Update README with correct ingestion endpoints

## Reference Files

**Ingestion API:**
- `/tmp/nomnom-ingestion-api-fixed/src/message_envelope.rs` - Envelope structure
- `/tmp/nomnom-ingestion-api-fixed/src/nats_client.rs` - NATS publishing
- Code generator: `src/codegen/ingestion_server/handlers_rs.rs`

**Worker:**
- Code generator: `src/codegen/worker/mod.rs`
- Entity config: `config/examples/tpch/entities/*.yaml`

**Database:**
- Schema: Auto-generated by Diesel migrations
- Tables: `orders`, `order_line_items`, `customers`, `products`

## Notes

- The ingestion API is working correctly (accepts and publishes messages)
- The NATS infrastructure is working correctly (streams exist, messages persist)
- The issue is purely in the worker's message parsing logic
- Fix should be straightforward once we identify the entity type mismatch
