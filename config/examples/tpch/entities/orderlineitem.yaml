# OrderLineItem entity - represents a line item within an order
# Based on TPC-H LINEITEM table
# Simplified version - just plain database fields

entity:
  name: OrderLineItem
  source_type: derived  # Derived from Order parent
  prefix: "L"  # Message prefix for ingestion server (different from Order's "O")
  repeated_for:
    entity: Order
    field: line_items  # Extract from line_items array in Order
    each_known_as: item  # Reference each line item as 'item'
  doc: "Represents a single line item within an order"

  fields:
    # Link to parent order - copy from parent Order
    - name: order_key
      type: String
      doc: "Order key (foreign key to orders table)"
      nullable: false
      computed_from:
        transform: copy_field
        sources:
          - source: Order
            field: order_key

    # Line item specific fields - extract from JSON item object
    - name: line_number
      type: Integer
      doc: "Line item sequence number within order"
      nullable: false
      computed_from:
        transform: json_get_int
        sources:
          - item
        args:
          field: "line_number"

    - name: part_key
      type: String
      doc: "Foreign key to product/part"
      nullable: false
      computed_from:
        transform: json_get_string
        sources:
          - item
        args:
          field: "part_key"

    - name: supplier_key
      type: String
      doc: "Foreign key to supplier"
      nullable: true
      computed_from:
        transform: json_get_optional_string
        sources:
          - item
        args:
          field: "supplier_key"

    - name: quantity
      type: Integer
      doc: "Quantity ordered"
      nullable: false
      computed_from:
        transform: json_get_int
        sources:
          - item
        args:
          field: "quantity"

    - name: extended_price
      type: Float
      doc: "Extended price (quantity * price)"
      nullable: false
      computed_from:
        transform: json_get_float
        sources:
          - item
        args:
          field: "extended_price"

    - name: discount
      type: Float
      doc: "Discount percentage (0.00 to 0.10)"
      nullable: true
      computed_from:
        transform: json_get_optional_float
        sources:
          - item
        args:
          field: "discount"

    - name: tax
      type: Float
      doc: "Tax percentage"
      nullable: true
      computed_from:
        transform: json_get_optional_float
        sources:
          - item
        args:
          field: "tax"

    - name: return_flag
      type: String
      doc: "Return flag (R=returned, A=accepted)"
      nullable: true
      computed_from:
        transform: json_get_optional_string
        sources:
          - item
        args:
          field: "return_flag"

    - name: line_status
      type: String
      doc: "Line status (O=open, F=fulfilled)"
      nullable: true
      computed_from:
        transform: json_get_optional_string
        sources:
          - item
        args:
          field: "line_status"

    - name: ship_date
      type: String
      doc: "Ship date (YYYY-MM-DD)"
      nullable: true
      computed_from:
        transform: json_get_optional_string
        sources:
          - item
        args:
          field: "ship_date"

    - name: commit_date
      type: String
      doc: "Commit date (YYYY-MM-DD)"
      nullable: true
      computed_from:
        transform: json_get_optional_string
        sources:
          - item
        args:
          field: "commit_date"

    - name: receipt_date
      type: String
      doc: "Receipt date (YYYY-MM-DD)"
      nullable: true
      computed_from:
        transform: json_get_optional_string
        sources:
          - item
        args:
          field: "receipt_date"

  # Database persistence configuration
  persistence:
    database:
      conformant_table: order_line_items
      conformant_id_column: id
      unicity_fields:
        - order_key
        - line_number  # Unique within an order

    primary_key:
      name: id
      type: Integer
      autogenerate: true

    field_overrides:
      - name: order_key
        type: String
        nullable: false

      - name: line_number
        type: Integer
        nullable: false

      - name: part_key
        type: String
        nullable: false

      - name: supplier_key
        type: String
        nullable: true

      - name: quantity
        type: Integer
        nullable: false

      - name: extended_price
        type: Float
        nullable: false

      - name: discount
        type: Float
        nullable: true

      - name: tax
        type: Float
        nullable: true

      - name: return_flag
        type: String
        nullable: true

      - name: line_status
        type: String
        nullable: true

      - name: ship_date
        type: String
        nullable: true

      - name: commit_date
        type: String
        nullable: true

      - name: receipt_date
        type: String
        nullable: true
